<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</title>
  <meta name="description" content="–°–æ–±–∏—Ä–∞–π –º—É—Å–æ—Ä, —Å—Ä–∞–∂–∞–π—Å—è —Å –±–æ—Å—Å–∞–º–∏, —Å–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–∑—å—è–º–∏!">
  <!-- PWA Manifest -->
  <link rel="manifest" href="application/manifest+json,{
    %22name%22:%22Space%20Junk%20Collector%22,
    %22short_name%22:%22Junk%20Collector%22,
    %22start_url%22:%22./%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23000000%22,
    %22theme_color%22:%22%232980b9%22,
    %22icons%22:[{
      %22src%22:%22image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='80' fill='%232ecc71'/%3E%3C/svg%3E%22,
      %22sizes%22:%22192x192%22,
      %22type%22:%22image/svg+xml%22
    }]
  }">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    body {
      background: #000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      background: #000;
    }
    #ui {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 18px;
      text-align: right;
      z-index: 10;
      text-shadow: 0 0 5px #0ff;
    }
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      z-index: 30;
      display: none;
    }
    #loading, #signupScreen { display: flex; }
    button {
      margin: 8px 0;
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      min-width: 200px;
    }
    button:hover { background: #2980b9; }
    input {
      padding: 10px;
      font-size: 14px;
      margin: 6px 0;
      width: 220px;
      border-radius: 4px;
      border: 1px solid #3498db;
    }
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: none;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }
    .mobile-btn {
      width: 60px;
      height: 60px;
      background: rgba(52, 152, 219, 0.5);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: white;
    }
    @media (max-width: 768px) {
      .mobile-controls { display: flex; }
    }
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      text-align: center;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    –°—á—ë—Ç: <span id="score">0</span> | –£—Ä. <span id="level">1</span><br>
    –í—Ä–µ–º—è: <span id="timer">60</span><br>
    –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">0</span><br>
    –í—ã: <span id="userEmail">‚Äî</span>
  </div>

  <div class="mobile-controls">
    <div class="mobile-btn" id="leftBtn">‚Üê</div>
    <div class="mobile-btn" id="rightBtn">‚Üí</div>
  </div>

  <div id="loading" class="screen">
    <h2>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</h2>
  </div>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
  <div id="signupScreen" class="screen">
    <h1>üöÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
    <input type="email" id="signupEmail" placeholder="email@example.com">
    <input type="password" id="signupPassword" placeholder="–ü–∞—Ä–æ–ª—å (6+ —Å–∏–º–≤–æ–ª–æ–≤)">
    <input type="text" id="signupUsername" placeholder="–ù–∏–∫–Ω–µ–π–º">
    <button onclick="signup()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</button>
    <div class="hint">–ù–∞ email –ø—Ä–∏–¥—ë—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
  </div>

  <!-- –í—Ö–æ–¥ -->
  <div id="loginScreen" class="screen">
    <h1>–í—Ö–æ–¥</h1>
    <input type="email" id="loginEmail" placeholder="email@example.com">
    <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <button onclick="sendPasswordReset()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
    <button onclick="showSignup()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</button>
  </div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="menu" class="screen">
    <h1>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</h1>
    <button onclick="startGame('casual')">Casual (90 —Å–µ–∫)</button>
    <button onclick="startGame('normal')">Normal (60 —Å–µ–∫)</button>
    <button onclick="startGame('hardcore')">Hardcore (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)</button>
    <button onclick="showLeaderboard()">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</button>
    <button onclick="showAchievements()">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
    <button onclick="sendPasswordReset()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
    <div>–ü—Ä–∏–≤–µ—Ç, <span id="menuUsername">‚Äî</span>!</div>
  </div>

  <!-- –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã -->
  <div id="gameOver" class="screen">
    <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h1>
    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="finalLevel">1</span></p>
    <p>–°—á—ë—Ç: <span id="finalScore">0</span></p>
    <button onclick="restartGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <button onclick="showMenu()">–í –º–µ–Ω—é</button>
    <button id="challengeBtn" style="display:none;">–ë—Ä–æ—Å–∏—Ç—å –≤—ã–∑–æ–≤</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
  <div id="leaderboard" class="screen">
    <h1>üèÜ –†–µ–∫–æ—Ä–¥—ã</h1>
    <button onclick="showGlobalLeaderboard()">–í—Å–µ –≤—Ä–µ–º—è</button>
    <button onclick="showWeeklyLeaderboard()">–ù–µ–¥–µ–ª—è</button>
    <div id="leaderboardList" style="text-align:left; width:280px; margin-top:15px;"></div>
    <button onclick="showMenu()">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
  <div id="achievements" class="screen">
    <h1>üèÖ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h1>
    <div id="achievementsList" style="text-align:left; width:280px; margin-top:15px;"></div>
    <button onclick="showMenu()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    // ================== Supabase Config ==================
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó SUPABASE!
    const SUPABASE_URL = 'https://sxercvykyvpijcmkbugy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4ZXJjdnlreXZwaWpjbWtidWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTMyMDgsImV4cCI6MjA3ODc4OTIwOH0.sIfZViicblM5kz7hNSt-FjnqB6Ngt9pUzO6noqxtggE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==================
    let currentUser = null;
    let gameActive = false;
    let paused = false;
    let currentMode = 'normal';
    let score = 0;
    let level = 1;
    let energy = 0;
    let timeLeft = 60;
    let wave = 0;
    let lastWaveTime = 0;
    let boss = null;
    let upgrades = { speed: 1, magnet: false, shield: false, shieldTimer: 0, activeCount: 0 };
    let achievements = {};
    let dailyChallenge = { type: 'debris', target: 20, current: 0 };

    // Canvas –∏ UI
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const timerEl = document.getElementById('timer');
    const energyEl = document.getElementById('energy');
    const userEmailEl = document.getElementById('userEmail');
    const menuUsernameEl = document.getElementById('menuUsername');
    const finalScoreEl = document.getElementById('finalScore');
    const finalLevelEl = document.getElementById('finalLevel');

    const loadingScreen = document.getElementById('loading');
    const signupScreen = document.getElementById('signupScreen');
    const loginScreen = document.getElementById('loginScreen');
    const menuEl = document.getElementById('menu');
    const gameOverEl = document.getElementById('gameOver');
    const leaderboardEl = document.getElementById('leaderboard');
    const achievementsEl = document.getElementById('achievements');
    const challengeBtn = document.getElementById('challengeBtn');

    // –ü—É–ª—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    const debrisPool = [];
    const asteroidPool = [];
    const particlePool = [];
    const bossPool = [];

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const keys = {};
    let gamepad = null;    // ================== –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ (—Å –ø—É–ª–∏–Ω–≥–æ–º) ==================
    function createDebris() {
      let d = debrisPool.pop();
      if (!d) {
        d = { x: 0, y: 0, width: 16, height: 16, type: 'plastic', speed: 4, vx: 0, vy: 0 };
      }
      const types = [
        { type: 'plastic', color: '#2ecc71', points: 10, energy: 1 },
        { type: 'metal', color: '#bdc3c7', points: 25, energy: 3 },
        { type: 'nuclear', color: '#e74c3c', points: 50, energy: 8, explode: true },
        { type: 'gold', color: '#f1c40f', points: 100, energy: 10, doublePoints: true }
      ];
      const type = types[Math.random() < 0.01 ? 3 : Math.random() < 0.03 ? 2 : Math.random() < 0.2 ? 1 : 0];
      Object.assign(d, {
        x: Math.random() * (canvas.width - 20),
        y: -20,
        ...type
      });
      return d;
    }

    function createAsteroid() {
      let a = asteroidPool.pop();
      if (!a) {
        a = { x: 0, y: 0, width: 30, height: 30, speed: 5 };
      }
      Object.assign(a, {
        x: Math.random() * (canvas.width - 30),
        y: -30,
        speed: 5 + wave * 0.5
      });
      return a;
    }

    function createBoss() {
      let b = bossPool.pop();
      if (!b) {
        b = { x: 0, y: 0, width: 60, height: 60, health: 1, maxHealth: 1, speed: 1.5, active: true };
      }
      const health = 3 + wave;
      Object.assign(b, {
        x: Math.random() * (canvas.width - 60),
        y: -60,
        health: health,
        maxHealth: health,
        speed: 1.5,
        active: true
      });
      return b;
    }

    function createParticle(x, y, color, vx = 0, vy = 0) {
      let p = particlePool.pop();
      if (!p) {
        p = { x: 0, y: 0, vx: 0, vy: 0, life: 30, color: '#fff' };
      }
      Object.assign(p, { x, y, vx, vy, life: 30, color });
      return p;
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    // ================== –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==================
    let debris = [];
    let asteroids = [];
    let particles = [];
    let station = null;
    let lastFrameTime = 0;
    let accumulatedTime = 0;
    const timeStep = 1000 / 60;
    let startTime = 0;
    let totalPlayTime = 0;
    let noHit = true;

    const player = {
      x: canvas.width / 2 - 15,
      y: canvas.height - 80,
      width: 30,
      height: 40,
      baseSpeed: 6,
      thrust: false
    };

    // ================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ==================
    window.addEventListener('keydown', (e) => {
      if (e.key === 'p' || e.key === 'P') {
        if (gameActive && !paused) togglePause();
        return;
      }
      keys[e.key] = true;
    });
    window.addEventListener('keyup', (e) => { keys[e.key] = false; });

    // –ì–µ–π–º–ø–∞–¥
    function checkGamepads() {
      const gamepads = navigator.getGamepads();
      for (let i = 0; i < gamepads.length; i++) {
        const gp = gamepads[i];
        if (gp) {
          // –õ–µ–≤—ã–π —Å—Ç–∏–∫: –æ—Å—å X
          if (gp.axes[0] < -0.5) keys.ArrowLeft = true;
          else if (gp.axes[0] > 0.5) keys.ArrowRight = true;
          else { keys.ArrowLeft = false; keys.ArrowRight = false; }
        }
      }
    }
    setInterval(checkGamepads, 100);

    // ================== –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã ==================
    function startGame(mode) {
      if (!currentUser || !currentUser.email_confirmed_at) {
        alert('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å!');
        return;
      }
      currentMode = mode;
      timeLeft = mode === 'casual' ? 90 : mode === 'normal' ? 60 : Infinity;
      gameActive = true;
      paused = false;
      score = 0;
      level = 1;
      energy = 0;
      wave = 0;
      lastWaveTime = 0;
      boss = null;
      station = null;
      upgrades = { speed: 1, magnet: false, shield: false, shieldTimer: 0, activeCount: 0 };
      debris = [];
      asteroids = [];
      particles = [];
      noHit = true;
      totalPlayTime = 0;

      scoreEl.textContent = score;
      levelEl.textContent = level;
      energyEl.textContent = energy;
      timerEl.textContent = timeLeft === Infinity ? '‚àû' : timeLeft;
      menuEl.style.display = 'none';
      gameOverEl.style.display = 'none';

      startTime = performance.now();
      lastFrameTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function togglePause() {
      paused = !paused;
    }

    // ================== –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ==================
    function gameLoop(timestamp) {
      if (!gameActive || paused) return;

      const deltaTime = timestamp - lastFrameTime;
      lastFrameTime = timestamp;
      accumulatedTime += deltaTime;
      totalPlayTime += deltaTime / 1000;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // –ü–∞—Ä–∞–ª–ª–∞–∫—Å-–∑–≤—ë–∑–¥—ã
      ctx.fillStyle = 'white';
      for (let i = 0; i < 50; i++) {
        const x = (Math.random() * canvas.width + totalPlayTime * 10) % canvas.width;
        const y = Math.random() * canvas.height;
        const size = Math.random() * 1.5;
        ctx.globalAlpha = Math.random() * 0.8 + 0.2;
        ctx.fillRect(x, y, size, size);
      }
      ctx.globalAlpha = 1;

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      const speed = player.baseSpeed * upgrades.speed;
      if (keys['ArrowLeft'] && player.x > 0) player.x -= speed;
      if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += speed;
      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
      player.thrust = keys['ArrowLeft'] || keys['ArrowRight'];

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —â–∏—Ç–∞
      if (upgrades.shield) {
        upgrades.shieldTimer--;
        if (upgrades.shieldTimer <= 0) {
          upgrades.shield = false;
          upgrades.activeCount--;
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —à–∞–≥–æ–º
      while (accumulatedTime >= timeStep) {
        updateGame();
        accumulatedTime -= timeStep;
      }

      // –†–µ–Ω–¥–µ—Ä
      renderGame();

      // –¢–∞–π–º–µ—Ä
      if (gameActive && currentMode !== 'hardcore') {
        const elapsed = (performance.now() - startTime) / 1000;
        timeLeft = Math.max(0, Math.floor((currentMode === 'casual' ? 90 : 60) - elapsed));
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
          return;
        }
      }

      // –í–æ–ª–Ω—ã
      if (totalPlayTime - lastWaveTime >= 20) {
        startNewWave();
        lastWaveTime = totalPlayTime;
      }

      requestAnimationFrame(gameLoop);
    }

    function updateGame() {
      // –°–ø–∞–≤–Ω –º—É—Å–æ—Ä–∞ –∏ –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤
      if (Math.random() < 0.03) debris.push(createDebris());
      if (Math.random() < 0.02) asteroids.push(createAsteroid());

      // –°–ø–∞–≤–Ω —Å—Ç–∞–Ω—Ü–∏–∏ (–∫–∞–∂–¥—ã–µ 45 —Å–µ–∫)
      if (station === null && totalPlayTime % 45 < 0.1 && Math.random() < 0.5) {
        station = {
          x: Math.random() * (canvas.width - 40),
          y: -40,
          width: 40,
          height: 40,
          active: true
        };
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
      if (station) {
        station.y += 2;
        if (checkCollision(player, station)) {
          // –î–∞—ë–º –≤—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –Ω–∞ 15 —Å–µ–∫
          upgrades.speed = 1.5;
          upgrades.magnet = true;
          upgrades.shield = true;
          upgrades.shieldTimer = 900; // 15 —Å–µ–∫ –ø—Ä–∏ 60 FPS
          setTimeout(() => {
            if (upgrades.speed === 1.5) upgrades.speed = 1;
            if (upgrades.magnet) upgrades.magnet = false;
            if (upgrades.shield && upgrades.shieldTimer > 0) {
              upgrades.shield = false;
              upgrades.activeCount = Math.max(0, upgrades.activeCount - 1);
            }
          }, 15000);
          station = null;
        } else if (station.y > canvas.height) {
          station = null;
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–∞
      for (let i = debris.length - 1; i >= 0; i--) {
        const d = debris[i];
        d.y += d.speed;

        // –ú–∞–≥–Ω–∏—Ç
        if (upgrades.magnet) {
          const dx = (player.x + player.width/2) - (d.x + d.width/2);
          const dy = (player.y + player.height/2) - (d.y + d.height/2);
          const dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < 150) {
            d.x += dx * 0.1;
            d.y += dy * 0.1;
          }
        }

        // –°–±–æ—Ä –º—É—Å–æ—Ä–∞
        if (checkCollision(player, d)) {
          const points = d.doublePoints ? d.points * 2 : d.points;
          score += points;
          energy += d.energy;
          scoreEl.textContent = score;
          energyEl.textContent = energy;

          // –ê–Ω–∏–º–∞—Ü–∏—è + —á–∞—Å—Ç–∏—Ü—ã
          for (let j = 0; j < 6; j++) {
            particles.push(createParticle(d.x + d.width/2, d.y + d.height/2, d.color, (Math.random()-0.5)*4, (Math.random()-0.5)*4));
          }

          // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
          unlockAchievement('firstDebris', '–ü–µ—Ä–≤—ã–π –º—É—Å–æ—Ä');
          if (score >= 500) unlockAchievement('score500', '500 –æ—á–∫–æ–≤!');
          if (score >= 1000) unlockAchievement('score1000', '1000 –æ—á–∫–æ–≤!');

          debrisPool.push(d);
          debris.splice(i, 1);
        } else if (d.y > canvas.height) {
          debrisPool.push(d);
          debris.splice(i, 1);
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤
      for (let i = asteroids.length - 1; i >= 0; i--) {
        const a = asteroids[i];
        a.y += a.speed;

        if (checkCollision(player, a)) {
          noHit = false;
          if (upgrades.shield) {
            upgrades.shield = false;
            upgrades.activeCount = Math.max(0, upgrades.activeCount - 1);
            for (let j = 0; j < 10; j++) {
              particles.push(createParticle(player.x + player.width/2, player.y + player.height/2, '#3498db', (Math.random()-0.5)*4, (Math.random()-0.5)*4));
            }
          } else {
            endGame();
            return;
          }
          asteroidPool.push(a);
          asteroids.splice(i, 1);
        } else if (a.y > canvas.height) {
          asteroidPool.push(a);
          asteroids.splice(i, 1);
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Å—Å–∞
      if (boss && boss.active) {
        boss.y += boss.speed;

        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º
        if (checkCollision(player, boss)) {
          noHit = false;
          if (upgrades.shield) {
            boss.health--;
            if (boss.health <= 0) {
              destroyBoss();
            } else {
              upgrades.shield = false;
              upgrades.activeCount = Math.max(0, upgrades.activeCount - 1);
            }
          } else {
            endGame();
            return;
          }
        }

        // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –º—É—Å–æ—Ä–æ–º (–¥–ª—è –∞—Ç–∞–∫–∏)
        for (let i = debris.length - 1; i >= 0; i--) {
          if (checkCollision(debris[i], boss)) {
            boss.health--;
            debrisPool.push(debris[i]);
            debris.splice(i, 1);
            if (boss.health <= 0) {
              destroyBoss();
              break;
            }
          }
        }

        if (boss.y > canvas.height) {
          boss.active = false;
          bossPool.push(boss);
          boss = null;
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–∏—Ü
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life--;
        if (p.life <= 0) {
          particlePool.push(p);
          particles.splice(i, 1);
        }
      }

      // –£—Ä–æ–≤–µ–Ω—å
      const newLevel = Math.floor(score / 500) + 1;
      if (newLevel > level) {
        level = newLevel;
        levelEl.textContent = level;
        unlockAchievement('level5', '–î–æ—Å—Ç–∏–≥ 5 —É—Ä–æ–≤–Ω—è');
      }
    }

    function renderGame() {
      // –ö–æ—Ä–∞–±–ª—å
      const topX = player.x + player.width / 2;
      const topY = player.y;
      const bottomLeftX = player.x;
      const bottomLeftY = player.y + player.height;
      const bottomRightX = player.x + player.width;
      const bottomRightY = player.y + player.height;

      ctx.fillStyle = player.thrust ? '#3498db' : '#2980b9';
      ctx.beginPath();
      ctx.moveTo(topX, topY);
      ctx.lineTo(bottomLeftX, bottomLeftY);
      ctx.lineTo(bottomRightX, bottomRightY);
      ctx.closePath();
      ctx.fill();

      // –î–≤–∏–≥–∞—Ç–µ–ª—å
      if (player.thrust) {
        ctx.fillStyle = '#f39c12';
        ctx.beginPath();
        ctx.moveTo(bottomLeftX + 8, bottomLeftY);
        ctx.lineTo(bottomRightX - 8, bottomRightY);
        ctx.lineTo(topX, bottomLeftY + 12 + Math.random() * 4);
        ctx.closePath();
        ctx.fill();
      }

      // –©–∏—Ç
      if (upgrades.shield) {
        ctx.beginPath();
        ctx.arc(topX, player.y + player.height/2, 35, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(0, 200, 255, 0.7)';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      // –ú—É—Å–æ—Ä
      debris.forEach(d => {
        ctx.fillStyle = d.color;
        ctx.beginPath();
        ctx.arc(d.x + d.width/2, d.y + d.height/2, d.width/2, 0, Math.PI * 2);
        ctx.fill();
        // –ê–Ω–∏–º–∞—Ü–∏—è —è–¥–µ—Ä–Ω–æ–≥–æ –º—É—Å–æ—Ä–∞
        if (d.type === 'nuclear') {
          ctx.strokeStyle = 'rgba(255, 255, 0, 0.5)';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.arc(d.x + d.width/2, d.y + d.height/2, d.width/2 + 5, 0, Math.PI * 2);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      });

      // –ê—Å—Ç–µ—Ä–æ–∏–¥—ã
      asteroids.forEach(a => {
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(a.x + a.width/2, a.y + a.height/2, a.width/2, 0, Math.PI * 2);
        ctx.fill();
      });

      // –ë–æ—Å—Å
      if (boss && boss.active) {
        ctx.fillStyle = '#8e44ad';
        ctx.beginPath();
        ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2, boss.width/2, 0, Math.PI * 2);
        ctx.fill();
        // –ü–æ–ª–æ—Å–∞ –∑–¥–æ—Ä–æ–≤—å—è
        ctx.fillStyle = '#e74c3c';
        ctx.fillRect(boss.x, boss.y - 10, boss.width, 5);
        ctx.fillStyle = '#2ecc71';
        ctx.fillRect(boss.x, boss.y - 10, boss.width * (boss.health / boss.maxHealth), 5);
      }

      // –°—Ç–∞–Ω—Ü–∏—è
      if (station) {
        ctx.fillStyle = '#f1c40f';
        ctx.beginPath();
        ctx.arc(station.x + station.width/2, station.y + station.height/2, station.width/2, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#e67e22';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 3]);
        ctx.arc(station.x + station.width/2, station.y + station.height/2, station.width/2 + 5, 0, Math.PI * 2);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // –ß–∞—Å—Ç–∏—Ü—ã
      particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 30;
        ctx.fillRect(p.x, p.y, 2, 2);
      });
      ctx.globalAlpha = 1;
    }

    function startNewWave() {
      wave++;
      // –°–æ–∑–¥–∞—ë–º –±–æ—Å—Å–∞ –∫–∞–∂–¥—É—é 2-—é –≤–æ–ª–Ω—É
      if (wave % 2 === 0) {
        boss = createBoss();
      }
      // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showNotification(`–í–æ–ª–Ω–∞ ${wave}! ${boss ? '–ë–æ—Å—Å –∞—Ç–∞–∫—É–µ—Ç!' : '–ì–æ—Ç–æ–≤—å—Ç–µ—Å—å!'}`);
    }

    function destroyBoss() {
      if (!boss) return;
      // –ß–∞—Å—Ç–∏—Ü—ã –≤–∑—Ä—ã–≤–∞
      for (let i = 0; i < 30; i++) {
        particles.push(createParticle(boss.x + boss.width/2, boss.y + boss.height/2, '#8e44ad', (Math.random()-0.5)*6, (Math.random()-0.5)*6));
      }
      // –ë–æ–Ω—É—Å
      score += 200;
      energy += 20;
      scoreEl.textContent = score;
      energyEl.textContent = energy;
      unlockAchievement('bossKiller', '–ü–æ–±–µ–¥–∏–ª –±–æ—Å—Å–∞');
      boss.active = false;
      bossPool.push(boss);
      boss = null;
    }
          // ================== –£–ª—É—á—à–µ–Ω–∏—è ==================
    function applyUpgrade(type) {
      if (upgrades.activeCount >= 2) {
        alert('–ú–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ 2 —É–ª—É—á—à–µ–Ω–∏—è!');
        return false;
      }
      if (type === 'speed' && energy >= 20) {
        energy -= 20;
        upgrades.speed += 0.3;
        upgrades.activeCount++;
        return true;
      }
      if (type === 'magnet' && energy >= 30) {
        energy -= 30;
        upgrades.magnet = true;
        upgrades.activeCount++;
        return true;
      }
      if (type === 'shield' && energy >= 50) {
        energy -= 50;
        upgrades.shield = true;
        upgrades.shieldTimer = 300;
        upgrades.activeCount++;
        unlockAchievement('shieldUser', '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª —â–∏—Ç');
        return true;
      }
      return false;
    }

    function showUpgrades() {
      const modal = document.createElement('div');
      modal.id = 'upgradesModal';
      modal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; justify-content:center; align-items:center; z-index:40;">
          <div style="background:#222; padding:20px; border-radius:10px; text-align:center; max-width:300px;">
            <h3>–£–ª—É—á—à–µ–Ω–∏—è (–º–∞–∫—Å. 2)</h3>
            <div>–≠–Ω–µ—Ä–≥–∏—è: <span id="modalEnergy">${energy}</span></div>
            <button onclick="applyUpgrade('speed'); updateModal();" style="display:block; width:100%; margin:10px 0;">+–°–∫–æ—Ä–æ—Å—Ç—å (${upgrades.speed > 1 ? '–£–ª—É—á—à–µ–Ω–æ' : '20 —ç–Ω–µ—Ä–≥–∏–∏'})</button>
            <button onclick="applyUpgrade('magnet'); updateModal();" style="display:block; width:100%; margin:10px 0;">–ú–∞–≥–Ω–∏—Ç (${upgrades.magnet ? '–ê–∫—Ç–∏–≤–µ–Ω' : '30 —ç–Ω–µ—Ä–≥–∏–∏'})</button>
            <button onclick="applyUpgrade('shield'); updateModal();" style="display:block; width:100%; margin:10px 0;">–©–∏—Ç (${upgrades.shield ? '–ê–∫—Ç–∏–≤–µ–Ω' : '50 —ç–Ω–µ—Ä–≥–∏–∏'})</button>
            <button onclick="document.getElementById('upgradesModal').remove();">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      updateModal();
    }

    function updateModal() {
      document.getElementById('modalEnergy').textContent = energy;
    }

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π
    window.addEventListener('keydown', (e) => {
      if (gameActive && !paused) {
        if (e.key === '1') applyUpgrade('speed');
        if (e.key === '2') applyUpgrade('magnet');
        if (e.key === '3') applyUpgrade('shield');
      }
    });

    // ================== –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è ==================
    function getTodaysChallenge() {
      const today = new Date().toISOString().split('T')[0];
      const stored = localStorage.getItem('dailyChallenge');
      if (stored) {
        const data = JSON.parse(stored);
        if (data.date === today) {
          return data;
        }
      }
      // –ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
      const challenges = [
        { type: 'debris', target: 20, desc: '–°–æ–±–µ—Ä–∏—Ç–µ 20 –º—É—Å–æ—Ä–∏–Ω' },
        { type: 'asteroid', target: 10, desc: '–ò–∑–±–µ–≥–∏—Ç–µ 10 –∞—Å—Ç–µ—Ä–æ–∏–¥–æ–≤' },
        { type: 'boss', target: 1, desc: '–ü–æ–±–µ–¥–∏—Ç–µ –±–æ—Å—Å–∞' },
        { type: 'energy', target: 100, desc: '–°–æ–±–µ—Ä–∏—Ç–µ 100 —ç–Ω–µ—Ä–≥–∏–∏' }
      ];
      const challenge = challenges[Math.floor(Math.random() * challenges.length)];
      const data = { ...challenge, current: 0, date: today, completed: false };
      localStorage.setItem('dailyChallenge', JSON.stringify(data));
      return data;
    }

    function updateDailyChallenge(type, amount = 1) {
      const challenge = getTodaysChallenge();
      if (challenge.completed) return;
      if (challenge.type === type) {
        challenge.current += amount;
        if (challenge.current >= challenge.target) {
          challenge.completed = true;
          unlockAchievement('dailyComplete', '–í—ã–ø–æ–ª–Ω–∏–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ');
          alert('–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +50 —ç–Ω–µ—Ä–≥–∏–∏!');
          energy += 50;
          energyEl.textContent = energy;
        }
        localStorage.setItem('dailyChallenge', JSON.stringify(challenge));
      }
    }

    // ================== –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã ==================
    async function endGame() {
      gameActive = false;
      finalScoreEl.textContent = score;
      finalLevelEl.textContent = level;
      gameOverEl.style.display = 'flex';

      // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
      if (noHit && totalPlayTime > 10) unlockAchievement('noHit', '–í—ã–∂–∏–ª –±–µ–∑ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π');
      if (currentMode === 'hardcore' && totalPlayTime > 120) unlockAchievement('hardcore', '–í—ã–∂–∏–ª –≤ Hardcore —Ä–µ–∂–∏–º–µ');

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∫–æ—Ä–¥
      if (currentUser && score > 0) {
        const username = currentUser.user_metadata?.username || '–ò–≥—Ä–æ–∫';
        try {
          // –ü–æ–ª—É—á–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∫–æ—Ä–¥
          const { data } = await supabase
            .from('scores')
            .select('score')
            .eq('user_id', currentUser.id)
            .eq('mode', currentMode)
            .order('score', { ascending: false })
            .limit(1);

          if (!data || data.length === 0 || score > data[0].score) {
            await supabase.from('scores').insert({
              user_id: currentUser.id,
              username: username,
              score: score,
              level: level,
              mode: currentMode,
              play_time: Math.floor(totalPlayTime)
            });
            showNotification('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!');
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', err);
        }
      }

      // –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞
      challengeBtn.style.display = 'block';
      challengeBtn.onclick = () => {
        const challengeUrl = `${window.location.origin}${window.location.pathname}?challenge=${currentMode}&score=${score}`;
        navigator.clipboard.writeText(challengeUrl).then(() => {
          alert('–°—Å—ã–ª–∫–∞ –≤—ã–∑–æ–≤–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É.');
        });
      };
    }

    function restartGame() {
      startGame(currentMode);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–∞
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('challenge')) {
      const mode = urlParams.get('challenge');
      const score = urlParams.get('score');
      setTimeout(() => {
        alert(`–î—Ä—É–≥ –±—Ä–æ—Å–∏–ª –≤–∞–º –≤—ã–∑–æ–≤!\n–†–µ–∂–∏–º: ${mode}\n–ï–≥–æ —Å—á—ë—Ç: ${score}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–±–∏—Ç—å!`);
      }, 1000);
    }

    // ================== –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ ==================
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      if (!gameActive) {
        player.x = canvas.width / 2 - 15;
      }
    });
          // ================== –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ ==================
    async function showLeaderboard() {
      menuEl.style.display = 'none';
      leaderboardEl.style.display = 'flex';
      showGlobalLeaderboard();
    }

    async function showGlobalLeaderboard() {
      try {
        const { data, error } = await supabase
          .from('scores')
          .select('username, score, level, mode, created_at')
          .order('score', { ascending: false })
          .limit(10);

        renderLeaderboard(data, '–í—Å–µ –≤—Ä–µ–º—è');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', err);
        document.getElementById('leaderboardList').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    async function showWeeklyLeaderboard() {
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const isoDate = oneWeekAgo.toISOString();

      try {
        const { data, error } = await supabase
          .from('scores')
          .select('username, score, level, mode, created_at')
          .gte('created_at', isoDate)
          .order('score', { ascending: false })
          .limit(10);

        renderLeaderboard(data, '–ù–µ–¥–µ–ª—è');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', err);
        document.getElementById('leaderboardList').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    function renderLeaderboard(data, title) {
      let html = `<div><strong>${title}</strong></div>`;
      if (data && data.length > 0) {
        data.forEach((row, i) => {
          const date = new Date(row.created_at).toLocaleDateString('ru-RU');
          const mode = row.mode === 'casual' ? 'C' : row.mode === 'normal' ? 'N' : 'H';
          html += `<div>${i+1}. ${row.username} ‚Äî ${row.score} (—É—Ä.${row.level}) [${mode}]</div>`;
        });
      } else {
        html += '<div>–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
      }
      document.getElementById('leaderboardList').innerHTML = html;
    }

    // ================== PWA –∏ –æ—Ñ–ª–∞–π–Ω ==================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // –û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã
    function saveLocalScore() {
      if (!currentUser) {
        const local = JSON.parse(localStorage.getItem('localScores') || '[]');
        local.push({ score, level, mode: currentMode, date: new Date().toISOString() });
        localStorage.setItem('localScores', JSON.stringify(local));
      }
    }

    // ================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
    getTodaysChallenge();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–∑–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('challenge')) {
      const mode = urlParams.get('challenge');
      const score = urlParams.get('score');
      setTimeout(() => {
        alert(`–î—Ä—É–≥ –±—Ä–æ—Å–∏–ª –≤–∞–º –≤—ã–∑–æ–≤!\n–†–µ–∂–∏–º: ${mode}\n–ï–≥–æ —Å—á—ë—Ç: ${score}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–±–∏—Ç—å!`);
      }, 1000);
    }

    // ================== –§–∏–Ω–∞–ª ==================
    console.log('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ê–≤—Ç–æ—Ä: tricksterlub');
  </script>
</body>
</html>
