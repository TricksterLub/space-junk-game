<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</title>
  <meta name="description" content="–°–æ–±–∏—Ä–∞–π –º—É—Å–æ—Ä, —Å—Ä–∞–∂–∞–π—Å—è —Å –±–æ—Å—Å–∞–º–∏, —Å–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–∑—å—è–º–∏!">
  <link rel="manifest" href="./manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    body {
      background: #000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      background: #000;
    }
    #ui {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 18px;
      text-align: right;
      z-index: 10;
      text-shadow: 0 0 5px #0ff;
    }
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      z-index: 30;
      display: none;
    }
    #loading, #signupScreen { display: flex; }
    button {
      margin: 8px 0;
      padding: 10px 20px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      min-width: 200px;
    }
    button:hover { background: #2980b9; }
    input {
      padding: 10px;
      font-size: 14px;
      margin: 6px 0;
      width: 220px;
      border-radius: 4px;
      border: 1px solid #3498db;
    }
    .mobile-controls {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: none;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 20;
    }
    .mobile-btn {
      width: 60px;
      height: 60px;
      background: rgba(52, 152, 219, 0.5);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: white;
    }
    @media (max-width: 768px) {
      .mobile-controls { display: flex; }
    }
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    –°—á—ë—Ç: <span id="score">0</span> | –£—Ä. <span id="level">1</span><br>
    –í—Ä–µ–º—è: <span id="timer">60</span><br>
    –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">0</span><br>
    –í—ã: <span id="userEmail">‚Äî</span>
  </div>

  <div class="mobile-controls">
    <div class="mobile-btn" id="leftBtn">‚Üê</div>
    <div class="mobile-btn" id="rightBtn">‚Üí</div>
  </div>

  <div id="loading" class="screen">
    <h2>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</h2>
  </div>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
  <div id="signupScreen" class="screen">
    <h1>üöÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
    <input type="email" id="signupEmail" placeholder="email@example.com">
    <input type="password" id="signupPassword" placeholder="–ü–∞—Ä–æ–ª—å (6+ —Å–∏–º–≤–æ–ª–æ–≤)">
    <input type="text" id="signupUsername" placeholder="–ù–∏–∫–Ω–µ–π–º">
    <button onclick="signup()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</button>
    <div class="hint">–ù–∞ email –ø—Ä–∏–¥—ë—Ç —Å—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
  </div>

  <!-- –í—Ö–æ–¥ -->
  <div id="loginScreen" class="screen">
    <h1>–í—Ö–æ–¥</h1>
    <input type="email" id="loginEmail" placeholder="email@example.com">
    <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="login()">–í–æ–π—Ç–∏</button>
    <button onclick="sendPasswordReset()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
    <button onclick="showSignup()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</button>
  </div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="menu" class="screen">
    <h1>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</h1>
    <button onclick="startGame('casual')">Casual (90 —Å–µ–∫)</button>
    <button onclick="startGame('normal')">Normal (60 —Å–µ–∫)</button>
    <button onclick="startGame('hardcore')">Hardcore (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)</button>
    <button onclick="showLeaderboard()">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</button>
    <button onclick="showMenu()">–í –º–µ–Ω—é</button>
  </div>

  <!-- –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã -->
  <div id="gameOver" class="screen">
    <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h1>
    <p>–£—Ä–æ–≤–µ–Ω—å: <span id="finalLevel">1</span></p>
    <p>–°—á—ë—Ç: <span id="finalScore">0</span></p>
    <button onclick="restartGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <button onclick="showMenu()">–í –º–µ–Ω—é</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
  <div id="leaderboard" class="screen">
    <h1>üèÜ –†–µ–∫–æ—Ä–¥—ã</h1>
    <button onclick="showGlobalLeaderboard()">–í—Å–µ –≤—Ä–µ–º—è</button>
    <button onclick="showWeeklyLeaderboard()">–ù–µ–¥–µ–ª—è</button>
    <div id="leaderboardList" style="text-align:left; width:280px; margin-top:15px;"></div>
    <button onclick="showMenu()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    // ================== Supabase Config ==================
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó SUPABASE!
    const SUPABASE_URL = 'https://sxercvykyvpijcmkbugy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4ZXJjdnlreXZwaWpjbWtidWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTMyMDgsImV4cCI6MjA3ODc4OTIwOH0.sIfZViicblM5kz7hNSt-FjnqB6Ngt9pUzO6noqxtggE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==================
    let currentUser = null;
    let gameActive = false;
    let paused = false;
    let currentMode = 'normal';
    let score = 0;
    let level = 1;
    let energy = 0;
    let timeLeft = 60;
    let wave = 0;
    let lastWaveTime = 0;
    let boss = null;
    let upgrades = { speed: 1, magnet: false, shield: false, shieldTimer: 0, activeCount: 0 };

    // Canvas –∏ UI
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const timerEl = document.getElementById('timer');
    const energyEl = document.getElementById('energy');
    const userEmailEl = document.getElementById('userEmail');
    const finalScoreEl = document.getElementById('finalScore');
    const finalLevelEl = document.getElementById('finalLevel');

    const loadingScreen = document.getElementById('loading');
    const signupScreen = document.getElementById('signupScreen');
    const loginScreen = document.getElementById('loginScreen');
    const menuEl = document.getElementById('menu');
    const gameOverEl = document.getElementById('gameOver');
    const leaderboardEl = document.getElementById('leaderboard');

    // –ü—É–ª—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    const debrisPool = [];
    const asteroidPool = [];
    const particlePool = [];
    const bossPool = [];

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    const keys = {};

    // ================== –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ==================
    document.getElementById('leftBtn').addEventListener('touchstart', () => keys.ArrowLeft = true);
    document.getElementById('leftBtn').addEventListener('touchend', () => keys.ArrowLeft = false);
    document.getElementById('rightBtn').addEventListener('touchstart', () => keys.ArrowRight = true);
    document.getElementById('rightBtn').addEventListener('touchend', () => keys.ArrowRight = false);

    // ================== –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ==================
    async function signup() {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const username = document.getElementById('signupUsername').value.trim();

      if (!email || !password || !username) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }
      if (password.length < 6) {
        alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
      }

      try {
        const { error } = await supabase.auth.signUp({
          email,
          password,
          options: {
             { username }
          }
        });
        if (error) throw error;
        alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
        showLogin();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!email || !password) {
        alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
        return;
      }

      try {
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
      }
    }

    async function sendPasswordReset() {
      const email = currentUser ? currentUser.email : prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email:');
      if (!email) return;

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + window.location.pathname
        });
        if (error) throw error;
        alert('–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ' + email);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    async function logout() {
      await supabase.auth.signOut();
    }

    async function checkAuth() {
      loadingScreen.style.display = 'flex';
      
      const {  { session } } = await supabase.auth.getSession();
      
      if (session && session.user.email_confirmed_at) {
        currentUser = session.user;
        userEmailEl.textContent = currentUser.email;
        signupScreen.style.display = 'none';
        loginScreen.style.display = 'none';
        menuEl.style.display = 'flex';
      } else {
        signupScreen.style.display = 'flex';
        loginScreen.style.display = 'none';
        menuEl.style.display = 'none';
      }
      
      loadingScreen.style.display = 'none';
    }

    checkAuth();

    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session?.user.email_confirmed_at) {
        currentUser = session.user;
        userEmailEl.textContent = currentUser.email;
        signupScreen.style.display = 'none';
        loginScreen.style.display = 'none';
        menuEl.style.display = 'flex';
      }
      if (event === 'SIGNED_OUT') {
        currentUser = null;
        signupScreen.style.display = 'flex';
        loginScreen.style.display = 'none';
        menuEl.style.display = 'none';
      }
    });

    function showSignup() {
      signupScreen.style.display = 'flex';
      loginScreen.style.display = 'none';
    }

    function showLogin() {
      loginScreen.style.display = 'flex';
      signupScreen.style.display = 'none';
    }

    function showMenu() {
      menuEl.style.display = 'flex';
      gameOverEl.style.display = 'none';
      leaderboardEl.style.display = 'none';
    }

    // ================== –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ ==================
    function createDebris() {
      let d = debrisPool.pop();
      if (!d) d = { x: 0, y: 0, width: 16, height: 16, type: 'plastic', speed: 4 };
      const types = [
        { type: 'plastic', color: '#2ecc71', points: 10, energy: 1 },
        { type: 'metal', color: '#bdc3c7', points: 25, energy: 3 },
        { type: 'nuclear', color: '#e74c3c', points: 50, energy: 8 },
        { type: 'gold', color: '#f1c40f', points: 100, energy: 10 }
      ];
      const type = types[Math.random() < 0.01 ? 3 : Math.random() < 0.03 ? 2 : Math.random() < 0.2 ? 1 : 0];
      Object.assign(d, {
        x: Math.random() * (canvas.width - 20),
        y: -20,
        ...type
      });
      return d;
    }

    function createAsteroid() {
      let a = asteroidPool.pop();
      if (!a) a = { x: 0, y: 0, width: 30, height: 30, speed: 5 };
      Object.assign(a, {
        x: Math.random() * (canvas.width - 30),
        y: -30,
        speed: 5 + wave * 0.5
      });
      return a;
    }

    function checkCollision(a, b) {
      return a.x < b.x + b.width &&
             a.x + a.width > b.x &&
             a.y < b.y + b.height &&
             a.y + a.height > b.y;
    }

    // ================== –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ==================
    let debris = [];
    let asteroids = [];
    let particles = [];
    let lastFrameTime = 0;
    let accumulatedTime = 0;
    const timeStep = 1000 / 60;
    let startTime = 0;
    let totalPlayTime = 0;

    const player = {
      x: canvas.width / 2 - 15,
      y: canvas.height - 80,
      width: 30,
      height: 40,
      baseSpeed: 6,
      thrust: false
    };

    // ================== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ==================
    window.addEventListener('keydown', (e) => {
      if (e.key === 'p' || e.key === 'P') {
        if (gameActive && !paused) togglePause();
        return;
      }
      keys[e.key] = true;
    });
    window.addEventListener('keyup', (e) => { keys[e.key] = false; });

    // ================== –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã ==================
    function startGame(mode) {
      if (!currentUser || !currentUser.email_confirmed_at) {
        alert('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å!');
        return;
      }
      currentMode = mode;
      timeLeft = mode === 'casual' ? 90 : mode === 'normal' ? 60 : Infinity;
      gameActive = true;
      paused = false;
      score = 0;
      level = 1;
      energy = 0;
      wave = 0;
      lastWaveTime = 0;
      boss = null;
      upgrades = { speed: 1, magnet: false, shield: false, shieldTimer: 0, activeCount: 0 };
      debris = [];
      asteroids = [];
      particles = [];
      totalPlayTime = 0;

      scoreEl.textContent = score;
      levelEl.textContent = level;
      energyEl.textContent = energy;
      timerEl.textContent = timeLeft === Infinity ? '‚àû' : timeLeft;
      menuEl.style.display = 'none';
      gameOverEl.style.display = 'none';

      startTime = performance.now();
      lastFrameTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function togglePause() {
      paused = !paused;
    }

    // ================== –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ==================
    function gameLoop(timestamp) {
      if (!gameActive || paused) return;

      const deltaTime = timestamp - lastFrameTime;
      lastFrameTime = timestamp;
      accumulatedTime += deltaTime;
      totalPlayTime += deltaTime / 1000;

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = 'white';
      for (let i = 0; i < 50; i++) {
        const x = (Math.random() * canvas.width + totalPlayTime * 10) % canvas.width;
        const y = Math.random() * canvas.height;
        const size = Math.random() * 1.5;
        ctx.globalAlpha = Math.random() * 0.8 + 0.2;
        ctx.fillRect(x, y, size, size);
      }
      ctx.globalAlpha = 1;

      const speed = player.baseSpeed * upgrades.speed;
      if (keys['ArrowLeft'] && player.x > 0) player.x -= speed;
      if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += speed;
      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
      player.thrust = keys['ArrowLeft'] || keys['ArrowRight'];

      while (accumulatedTime >= timeStep) {
        updateGame();
        accumulatedTime -= timeStep;
      }

      renderGame();

      if (gameActive && currentMode !== 'hardcore') {
        const elapsed = (performance.now() - startTime) / 1000;
        timeLeft = Math.max(0, Math.floor((currentMode === 'casual' ? 90 : 60) - elapsed));
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
          return;
        }
      }

      if (totalPlayTime - lastWaveTime >= 20) {
        wave++;
        if (wave % 2 === 0) {
          // –°–æ–∑–¥–∞—ë–º –±–æ—Å—Å–∞
        }
      }

      requestAnimationFrame(gameLoop);
    }

    function updateGame() {
      if (Math.random() < 0.03) debris.push(createDebris());
      if (Math.random() < 0.02) asteroids.push(createAsteroid());

      for (let i = debris.length - 1; i >= 0; i--) {
        debris[i].y += 4;
        if (checkCollision(player, debris[i])) {
          score += debris[i].points;
          energy += debris[i].energy;
          scoreEl.textContent = score;
          energyEl.textContent = energy;
          debrisPool.push(debris[i]);
          debris.splice(i, 1);
        } else if (debris[i].y > canvas.height) {
          debrisPool.push(debris[i]);
          debris.splice(i, 1);
        }
      }

      for (let i = asteroids.length - 1; i >= 0; i--) {
        asteroids[i].y += 5;
        if (checkCollision(player, asteroids[i])) {
          endGame();
          return;
        } else if (asteroids[i].y > canvas.height) {
          asteroidPool.push(asteroids[i]);
          asteroids.splice(i, 1);
        }
      }

      const newLevel = Math.floor(score / 500) + 1;
      if (newLevel > level) {
        level = newLevel;
        levelEl.textContent = level;
      }
    }

    function renderGame() {
      const topX = player.x + player.width / 2;
      const topY = player.y;
      const bottomLeftX = player.x;
      const bottomLeftY = player.y + player.height;
      const bottomRightX = player.x + player.width;
      const bottomRightY = player.y + player.height;

      ctx.fillStyle = player.thrust ? '#3498db' : '#2980b9';
      ctx.beginPath();
      ctx.moveTo(topX, topY);
      ctx.lineTo(bottomLeftX, bottomLeftY);
      ctx.lineTo(bottomRightX, bottomRightY);
      ctx.closePath();
      ctx.fill();

      if (player.thrust) {
        ctx.fillStyle = '#f39c12';
        ctx.beginPath();
        ctx.moveTo(bottomLeftX + 8, bottomLeftY);
        ctx.lineTo(bottomRightX - 8, bottomRightY);
        ctx.lineTo(topX, bottomLeftY + 12 + Math.random() * 4);
        ctx.closePath();
        ctx.fill();
      }

      debris.forEach(d => {
        ctx.fillStyle = d.color;
        ctx.beginPath();
        ctx.arc(d.x + 8, d.y + 8, 8, 0, Math.PI * 2);
        ctx.fill();
      });

      asteroids.forEach(a => {
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.arc(a.x + 15, a.y + 15, 15, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // ================== –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã ==================
    async function endGame() {
      gameActive = false;
      finalScoreEl.textContent = score;
      finalLevelEl.textContent = level;
      gameOverEl.style.display = 'flex';

      if (currentUser && score > 0) {
        const username = currentUser.user_metadata?.username || '–ò–≥—Ä–æ–∫';
        try {
          const { data } = await supabase
            .from('scores')
            .select('score')
            .eq('user_id', currentUser.id)
            .eq('mode', currentMode)
            .order('score', { ascending: false })
            .limit(1);

          if (!data || data.length === 0 || score > data[0].score) {
            await supabase.from('scores').insert({
              user_id: currentUser.id,
              username: username,
              score: score,
              level: level,
              mode: currentMode
            });
          }
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞:', err);
        }
      }
    }

    function restartGame() {
      startGame(currentMode);
    }

    // ================== –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ ==================
    async function showLeaderboard() {
      menuEl.style.display = 'none';
      leaderboardEl.style.display = 'flex';
      showGlobalLeaderboard();
    }

    async function showGlobalLeaderboard() {
      try {
        const { data, error } = await supabase
          .from('scores')
          .select('username, score, level, mode, created_at')
          .order('score', { ascending: false })
          .limit(10);

        renderLeaderboard(data, '–í—Å–µ –≤—Ä–µ–º—è');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', err);
        document.getElementById('leaderboardList').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    async function showWeeklyLeaderboard() {
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const isoDate = oneWeekAgo.toISOString();

      try {
        const { data, error } = await supabase
          .from('scores')
          .select('username, score, level, mode, created_at')
          .gte('created_at', isoDate)
          .order('score', { ascending: false })
          .limit(10);

        renderLeaderboard(data, '–ù–µ–¥–µ–ª—è');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤:', err);
        document.getElementById('leaderboardList').innerHTML = '<div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    function renderLeaderboard(data, title) {
      let html = `<div><strong>${title}</strong></div>`;
      if (data && data.length > 0) {
        data.forEach((row, i) => {
          const date = new Date(row.created_at).toLocaleDateString('ru-RU');
          const mode = row.mode === 'casual' ? 'C' : row.mode === 'normal' ? 'N' : 'H';
          html += `<div>${i+1}. ${row.username} ‚Äî ${row.score} (—É—Ä.${row.level}) [${mode}]</div>`;
        });
      } else {
        html += '<div>–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
      }
      document.getElementById('leaderboardList').innerHTML = html;
    }

    // ================== PWA ==================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // ================== –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ ==================
    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      if (!gameActive) {
        player.x = canvas.width / 2 - 15;
      }
    });

    // ================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('challenge')) {
      const mode = urlParams.get('challenge');
      const score = urlParams.get('score');
      setTimeout(() => {
        alert(`–î—Ä—É–≥ –±—Ä–æ—Å–∏–ª –≤–∞–º –≤—ã–∑–æ–≤!\n–†–µ–∂–∏–º: ${mode}\n–ï–≥–æ —Å—á—ë—Ç: ${score}\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–±–∏—Ç—å!`);
      }, 1000);
    }
  </script>
</body>
</html>
