<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
    body {
      background: #000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      background: #000;
    }
    #ui {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 18px;
      text-align: right;
      z-index: 10;
      text-shadow: 0 0 5px #0ff;
    }
    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      z-index: 30;
      display: none;
    }
    #loginScreen { display: flex; }
    button {
      margin: 10px 0;
      padding: 12px 24px;
      font-size: 18px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      min-width: 220px;
    }
    input {
      padding: 12px;
      font-size: 16px;
      margin: 10px 0;
      width: 250px;
      border-radius: 6px;
      border: 1px solid #3498db;
    }
    .hint {
      font-size: 14px;
      color: #999;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <div id="ui">
    –°—á—ë—Ç: <span id="score">0</span><br>
    –í—Ä–µ–º—è: <span id="timer">60</span><br>
    –í—ã: <span id="userEmail">‚Äî</span>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
  <div id="loginScreen" class="screen">
    <h1>üöÄ –í–æ–π–¥–∏—Ç–µ –≤ –∏–≥—Ä—É</h1>
    <input type="email" id="emailInput" placeholder="–≤–∞—à@email.com" required>
    <button onclick="login()">–í–æ–π—Ç–∏ –ø–æ email</button>
    <div class="hint">
      üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: Gmail, Outlook, iCloud<br>
      Mail.ru –∏ Yandex —á–∞—Å—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç –ø–∏—Å—å–º–∞
    </div>
  </div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="menu" class="screen">
    <h1>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –°–±–æ—Ä—â–∏–∫ –ú—É—Å–æ—Ä–∞</h1>
    <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button onclick="showLeaderboard()">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</button>
  </div>

  <!-- –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã -->
  <div id="gameOver" class="screen">
    <h1>–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h1>
    <p>–í–∞—à —Å—á—ë—Ç: <span id="finalScore">0</span></p>
    <button onclick="restartGame()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    <button onclick="showMenu()">–í –º–µ–Ω—é</button>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤ -->
  <div id="leaderboard" class="screen">
    <h1>üèÜ –¢–æ–ø 10 –∏–≥—Ä–æ–∫–æ–≤</h1>
    <div id="leaderboardList" style="text-align:left; width:300px; margin-top:20px;"></div>
    <button onclick="showMenu()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    // ================== Supabase Config ==================
    // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –°–¢–†–û–ö–ò –ù–ê –°–í–û–ò –ò–ó SUPABASE DASHBOARD!
    const SUPABASE_URL = 'https://sxercvykyvpijcmkbugy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4ZXJjdnlreXZwaWpjbWtidWd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTMyMDgsImV4cCI6MjA3ODc4OTIwOH0.sIfZViicblM5kz7hNSt-FjnqB6Ngt9pUzO6noqxtggE';

    // –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç –°–†–ê–ó–£
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;

    // ================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const userEmailEl = document.getElementById('userEmail');
    const finalScoreEl = document.getElementById('finalScore');

    const loginScreen = document.getElementById('loginScreen');
    const menuEl = document.getElementById('menu');
    const gameOverEl = document.getElementById('gameOver');
    const leaderboardEl = document.getElementById('leaderboard');

    let score = 0;
    let timeLeft = 60;
    let gameActive = false;
    let debris = [];
    let asteroids = [];
    let lastFrameTime = 0;
    let accumulatedTime = 0;
    const timeStep = 1000 / 60;
    let startTime = 0;

    const player = {
      x: canvas.width / 2 - 15,
      y: canvas.height - 80,
      width: 30,
      height: 40,
      speed: 6
    };

    const keys = {};
    window.addEventListener('keydown', (e) => { keys[e.key] = true; });
    window.addEventListener('keyup', (e) => { keys[e.key] = false; });

    // ================== –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ==================
    async function login() {
      const email = document.getElementById('emailInput').value.trim();
      if (!email || !email.includes('@')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
        return;
      }

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: 'https://tricksterlub.github.io/space-junk-game/'
        }
      });
      if (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        return;
      }
      alert('–ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ ' + email + '\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É (–∏ –ø–∞–ø–∫—É –°–ø–∞–º)!');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    supabase.auth.getSession().then((result) => {
      const session = result.data.session;
      if (session) {
        currentUser = session.user;
        userEmailEl.textContent = currentUser.email;
        loginScreen.style.display = 'none';
        menuEl.style.display = 'flex';
      }
    });

    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        currentUser = session.user;
        userEmailEl.textContent = currentUser.email;
        loginScreen.style.display = 'none';
        menuEl.style.display = 'flex';
      }
      if (event === 'SIGNED_OUT') {
        currentUser = null;
        loginScreen.style.display = 'flex';
        menuEl.style.display = 'none';
      }
    });

    // ================== –ò–≥—Ä–∞ ==================
    function startGame() {
      if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç!');
        return;
      }
      score = 0;
      timeLeft = 60;
      gameActive = true;
      debris = [];
      asteroids = [];

      scoreEl.textContent = score;
      timerEl.textContent = timeLeft;
      menuEl.style.display = 'none';
      gameOverEl.style.display = 'none';

      startTime = performance.now();
      lastFrameTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function gameLoop(timestamp) {
      if (!gameActive) return;

      const deltaTime = timestamp - lastFrameTime;
      lastFrameTime = timestamp;
      accumulatedTime += deltaTime;

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
      if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;
      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));

      while (accumulatedTime >= timeStep) {
        update();
        accumulatedTime -= timeStep;
      }

      render();

      if (gameActive) {
        const elapsed = (performance.now() - startTime) / 1000;
        timeLeft = Math.max(0, Math.floor(60 - elapsed));
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
          return;
        }
      }

      requestAnimationFrame(gameLoop);
    }

    function update() {
      if (Math.random() < 0.03) createDebris();
      if (Math.random() < 0.02) createAsteroid();

      for (let i = debris.length - 1; i >= 0; i--) {
        debris[i].y += 4;
        if (checkCollision(player, debris[i])) {
          score += 10;
          scoreEl.textContent = score; // ‚Üê –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –°–ß–Å–¢!
          debris.splice(i, 1);
        }
      }

      for (let i = asteroids.length - 1; i >= 0; i--) {
        asteroids[i].y += 5;
        if (checkCollision(player, asteroids[i])) {
          endGame();
          return;
        }
      }
    }

    function render() {
      ctx.fillStyle = '#3498db';
      ctx.fillRect(player.x, player.y, player.width, player.height);

      ctx.fillStyle = '#2ecc71';
      debris.forEach(d => {
        ctx.beginPath();
        ctx.arc(d.x + 8, d.y + 8, 8, 0, Math.PI * 2);
        ctx.fill();
      });

      ctx.fillStyle = '#e74c3c';
      asteroids.forEach(a => {
        ctx.beginPath();
        ctx.arc(a.x + 15, a.y + 15, 15, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    function createDebris() {
      debris.push({ x: Math.random() * (canvas.width - 16), y: -16 });
    }

    function createAsteroid() {
      asteroids.push({ x: Math.random() * (canvas.width - 30), y: -30 });
    }

    function checkCollision(a, b) {
      return a.x < b.x + 30 &&
             a.x + a.width > b.x &&
             a.y < b.y + 30 &&
             a.y + a.height > b.y;
    }

    async function endGame() {
      gameActive = false;
      finalScoreEl.textContent = score;
      gameOverEl.style.display = 'flex';

      if (currentUser && score > 0) {
        // –ü–æ–ª—É—á–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∫–æ—Ä–¥ –∏–≥—Ä–æ–∫–∞
        const { data, error } = await supabase
          .from('scores')
          .select('score')
          .eq('user_id', currentUser.id)
          .order('score', { ascending: false })
          .limit(1);

        if (data && data.length > 0) {
          const bestScore = data[0].score;
          if (score > bestScore) {
            await supabase.from('scores').insert({
              user_id: currentUser.id,
              score: score
            });
          }
        } else {
          // –ü–µ—Ä–≤—ã–π —Ä–µ–∫–æ—Ä–¥
          await supabase.from('scores').insert({
            user_id: currentUser.id,
            score: score
          });
        }
      }
    }

    function restartGame() {
      startGame();
    }

    function showMenu() {
      menuEl.style.display = 'flex';
      gameOverEl.style.display = 'none';
      leaderboardEl.style.display = 'none';
    }

    async function showLeaderboard() {
      const { data, error } = await supabase
        .from('scores')
        .select('user_id, score')
        .order('score', { ascending: false })
        .limit(10);

      let html = '<div><strong>–¢–æ–ø 10:</strong></div>';
      if (data) {
        data.forEach((row, i) => {
          html += `<div>${i+1}. –ò–≥—Ä–æ–∫-${row.user_id.substring(0,6)} ‚Äî ${row.score}</div>`;
        });
      } else {
        html += '<div>–ù–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤</div>';
      }
      document.getElementById('leaderboardList').innerHTML = html;
      menuEl.style.display = 'none';
      leaderboardEl.style.display = 'flex';
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      if (!gameActive) {
        player.x = canvas.width / 2 - 15;
      }
    });
  </script>
</body>
</html>

